name: Release (Android + Desktop)

on:
  push:
    branches: [ "main" ]

permissions:
  contents: write

concurrency:
  group: release-main
  cancel-in-progress: false

jobs:
  meta:
    name: Resolve version from gradle.properties
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.ver.outputs.tag }}
      version: ${{ steps.ver.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Read VERSION_NAME
        id: ver
        shell: bash
        run: |
          set -euo pipefail
          VERSION="$(grep -E '^VERSION_NAME=' gradle.properties | cut -d'=' -f2- | tr -d '\r' | xargs || true)"
          if [ -z "${VERSION:-}" ]; then
            echo "VERSION_NAME est vide. Ajoute VERSION_NAME=MAJOR.MINOR.PATCH dans gradle.properties."
            exit 1
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "tag=v$VERSION" >> "$GITHUB_OUTPUT"

  build-android:
    name: Build Android (APK + AAB)
    needs: meta
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Make Gradle wrapper executable
        shell: bash
        run: chmod +x gradlew

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Ensure Android SDK packages + accept licenses (robust)
        shell: bash
        run: |
          set -euo pipefail

          ANDROID_SDK_ROOT="${ANDROID_SDK_ROOT:-${ANDROID_HOME:-}}"
          if [ -z "${ANDROID_SDK_ROOT:-}" ]; then
            echo "ANDROID_SDK_ROOT/ANDROID_HOME introuvable sur le runner."
            env | sort
            exit 1
          fi

          echo "ANDROID_HOME=$ANDROID_SDK_ROOT" >> "$GITHUB_ENV"
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> "$GITHUB_ENV"

          SDKMANAGER="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager"
          if [ ! -x "$SDKMANAGER" ]; then
            SDKMANAGER="$(find "$ANDROID_SDK_ROOT/cmdline-tools" -name sdkmanager -type f | head -n 1 || true)"
          fi
          if [ -z "${SDKMANAGER:-}" ] || [ ! -x "$SDKMANAGER" ]; then
            echo "sdkmanager introuvable"
            find "$ANDROID_SDK_ROOT" -maxdepth 6 -type f -name sdkmanager -print || true
            exit 1
          fi

          echo "Using sdkmanager: $SDKMANAGER"

          set +o pipefail
          yes | "$SDKMANAGER" --licenses >/dev/null 2>&1 || true
          yes | "$SDKMANAGER" --sdk_root="$ANDROID_SDK_ROOT" \
            "platform-tools" \
            "platforms;android-36" \
            "build-tools;36.0.0" >/dev/null 2>&1 || true
          set -o pipefail

      - name: Decode Android keystore
        shell: bash
        run: |
          set -euo pipefail
          test -n "${{ secrets.ANDROID_KEYSTORE_B64 }}" || (echo "ANDROID_KEYSTORE_B64 missing" && exit 1)
          echo "${{ secrets.ANDROID_KEYSTORE_B64 }}" | base64 -d > "$RUNNER_TEMP/sochief-release.jks"
          echo "ANDROID_KEYSTORE_PATH=$RUNNER_TEMP/sochief-release.jks" >> "$GITHUB_ENV"
          echo "ANDROID_KEYSTORE_PASSWORD=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" >> "$GITHUB_ENV"
          echo "ANDROID_KEY_ALIAS=${{ secrets.ANDROID_KEY_ALIAS }}" >> "$GITHUB_ENV"
          echo "ANDROID_KEY_PASSWORD=${{ secrets.ANDROID_KEY_PASSWORD }}" >> "$GITHUB_ENV"

      - name: Build APK (release)
        shell: bash
        run: ./gradlew :composeApp:assembleRelease

      - name: Build AAB (release)
        continue-on-error: true
        shell: bash
        run: ./gradlew :composeApp:bundleRelease

      - name: Collect + rename Android outputs (SoChief.*)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist/android

          APK="$(ls -1 composeApp/build/outputs/apk/release/*.apk | head -n 1)"
          cp -v "$APK" dist/android/SoChief.apk

          if ls composeApp/build/outputs/bundle/release/*.aab >/dev/null 2>&1; then
            AAB="$(ls -1 composeApp/build/outputs/bundle/release/*.aab | head -n 1)"
            cp -v "$AAB" dist/android/SoChief.aab
          else
            echo "No AAB produced (bundleRelease failed or skipped)."
          fi

      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-${{ needs.meta.outputs.tag }}
          path: dist/android/*
          if-no-files-found: error

  build-desktop:
    name: Build Desktop (${{ matrix.label }})
    needs: meta
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            label: linux
            task_unix: :composeApp:packageDeb
            out_glob: "composeApp/build/compose/binaries/main/deb/*.deb"
            out_ext: "deb"
          - os: macos-latest
            label: macos
            task_unix: :composeApp:packageDmg
            out_glob: "composeApp/build/compose/binaries/main/dmg/*.dmg"
            out_ext: "dmg"
          - os: windows-latest
            label: windows
            task_win: :composeApp:packageMsi
            out_glob: "composeApp/build/compose/binaries/main/msi/*.msi"
            out_ext: "msi"
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Make Gradle wrapper executable (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: chmod +x gradlew

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Build installer (Linux/macOS)
        if: runner.os != 'Windows'
        shell: bash
        run: ./gradlew ${{ matrix.task_unix }}

      - name: Build installer (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: .\gradlew.bat ${{ matrix.task_win }}

      - name: Patch .deb desktop file (single entry handled by postinst)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          set -euo pipefail

          DEB="$(ls -1 composeApp/build/compose/binaries/main/deb/*.deb | head -n 1)"
          echo "Deb found: $DEB"

          WORKDIR="$(mktemp -d)"
          dpkg-deb -R "$DEB" "$WORKDIR"

          # 1) Prefer the exact path used by Compose default packaging for packageName=sochief
          DESKTOP="$WORKDIR/opt/sochief/lib/sochief-SoChief.desktop"
          if [ ! -f "$DESKTOP" ]; then
            echo "Expected desktop not found at $DESKTOP, searching..."
            DESKTOP="$(find "$WORKDIR" -path "*/opt/*/lib/*.desktop" | head -n 1 || true)"
          fi

          if [ -z "${DESKTOP:-}" ] || [ ! -f "$DESKTOP" ]; then
            echo "No .desktop found under /opt/*/lib in deb"
            find "$WORKDIR" -maxdepth 10 -type f -name "*.desktop" -print || true
            exit 1
          fi

          echo "Desktop file to patch: $DESKTOP"
          echo "Before:"
          cat "$DESKTOP" || true

          APP_NAME="SoChief"
          APP_ICON="sochief"
          WMCLASS="fr-vlegall-sochief-client-MainKt"

          set_kv() {
            local key="$1" value="$2" file="$3"
            if grep -qE "^${key}=" "$file"; then
              sed -i "s|^${key}=.*|${key}=${value}|" "$file"
            else
              printf "\n%s=%s\n" "$key" "$value" >> "$file"
            fi
          }

          set_kv "Name" "$APP_NAME" "$DESKTOP"
          set_kv "Icon" "$APP_ICON" "$DESKTOP"
          set_kv "StartupWMClass" "$WMCLASS" "$DESKTOP"

          echo "After:"
          cat "$DESKTOP"

          dpkg-deb -b "$WORKDIR" "$DEB"
          rm -rf "$WORKDIR"

      - name: Collect + rename Desktop output (SoChief.${{ matrix.out_ext }})
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist/desktop
          shopt -s nullglob
          files=( ${{ matrix.out_glob }} )
          if [ ${#files[@]} -eq 0 ]; then
            echo "Aucun fichier trouv√© pour: ${{ matrix.out_glob }}"
            ls -R composeApp/build/compose/binaries || true
            exit 1
          fi

          src="${files[0]}"
          cp -v "$src" "dist/desktop/SoChief.${{ matrix.out_ext }}"

      - name: Upload Desktop artifacts
        uses: actions/upload-artifact@v4
        with:
          name: desktop-${{ matrix.label }}-${{ needs.meta.outputs.tag }}
          path: dist/desktop/*
          if-no-files-found: error

  release:
    name: Create/Update GitHub Release (no git push tag)
    needs: [ meta, build-desktop, build-android ]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: List files
        shell: bash
        run: |
          set -euo pipefail
          echo "Artifacts:"
          find dist -type f -maxdepth 8 -print || true

      - name: Create release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.meta.outputs.tag }}
          target_commitish: ${{ github.sha }}
          name: ${{ needs.meta.outputs.tag }}
          generate_release_notes: true
          fail_on_unmatched_files: false
          files: |
            dist/**/SoChief.apk
            dist/**/SoChief.aab
            dist/**/SoChief.deb
            dist/**/SoChief.msi
            dist/**/SoChief.dmg